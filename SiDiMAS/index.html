
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>SMAN 9 Kota Jambi - SiDiMAS</title>
    <link rel="icon" type="image/png" href="./logo.png">


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  
  <style>
    :root { --main-color: #0d6efd; }
    body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow-x: hidden; display: block !important; }

     /* Mencegah zoom cubitan layar dan efek membal saat mentok */
html, body {
    touch-action: pan-y; 
    overscroll-behavior-y: none; }

/* Mencegah zoom otomatis saat mengklik kolom input / form */
input, button, select, textarea {
    touch-action: manipulation; 
    font-size: 16px !important; }

    .hide { display: none !important; }
    
    #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--main-color) 0%, #004085 100%); padding: 20px; overflow-y: auto; }
    .login-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 100%; max-width: 420px; padding: 40px; text-align: center; }
    .login-logo { height: 70px; object-fit: contain; margin: 0 10px; }
    .login-instansi { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 1px; margin-top: 10px;}
    .login-sekolah { font-size: 1.2rem; font-weight: 800; text-transform: uppercase; color: var(--main-color); margin-bottom: 15px; }
    .login-logo2 { height: 90px; object-fit: center; margin: 0 0px; }
    
    #view-dashboard { width: 100%; min-height: 100vh; position: relative; display: block; }
    .sidebar { width: 250px; height: 100vh; position: fixed; top: 0; left: 0; background: var(--main-color); color: white; padding-top: 20px; z-index: 1000; transition: 0.3s; overflow-y: auto; }
    .main-content { margin-left: 250px; width: calc(100% - 250px); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; justify-content: flex-start; }
    
    .nav-link { color: rgba(255,255,255,0.85); padding: 12px 20px; cursor: pointer; border-left: 4px solid transparent; display: flex; align-items: center;}
    .nav-link:hover, .nav-link.active { color: white; background: rgba(0,0,0,0.15); border-left-color: #ffc107; }
    .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
    
    .header-kop { background: white; padding: 15px; margin-bottom: 20px; border-radius: 10px; border-bottom: 4px double var(--main-color); display: flex; align-items: center; justify-content: center; gap: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .kop-logo { height: 80px; width: 80px; object-fit: contain; }
    .kop-text { text-align: center; color: #333; max-width: 700px; }
    .txt-instansi { font-size: 1rem; font-weight: bold; display: block; letter-spacing: 1px; line-height: 1.2;}
    .txt-opd { font-size: 1.1rem; font-weight: bold; display: block; line-height: 1.2;}
    .txt-sekolah { font-size: 1.4rem; font-weight: 900; display: block; color: var(--main-color); text-transform: uppercase; line-height: 1.2; margin: 5px 0;}
    .txt-alamat { font-size: 0.85rem; font-style: italic; display: block; color: #555;}
    
    .footer { text-align: center; padding: 15px; font-size: 0.8rem; color: #6c757d; border-top: 1px solid #dee2e6; background: white; margin-top: auto; }
    #view-login .footer { background: transparent; color: rgba(255,255,255,0.8); border: none; margin-top: 20px; }
    
    .preview-box { background: #e9ecef; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 1.2rem; text-align: center; border: 2px dashed #adb5bd; color: #495057; font-weight: bold; margin-bottom: 15px; letter-spacing: 1px;}
    .form-box { animation: fadeIn 0.5s; }
    .btn-refresh { border-radius: 50%; width: 35px; height: 35px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .btn-scroll-top { position: fixed; bottom: 20px; right: 20px; border-radius: 50%; width: 45px; height: 45px; display: none; align-items: center; justify-content: center; z-index: 1050; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; display: block; width: 100%; }
    table { white-space: nowrap; }
    
    div:where(.swal2-container) { z-index: 11000 !important; }
    .modal { z-index: 10050 !important; }
    
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    
    @media (max-width: 768px) { 
        /* Sembunyikan sidebar bawaan di HP */
        .sidebar { display: none !important; } 
        /* Beri ruang di bawah agar konten tidak tertutup menu navigasi */
        .main-content { margin-left: 0; width: 100%; padding: 15px; padding-bottom: 90px; } 
        
        /* HEADER HP */
        .header-kop { flex-direction: row; gap: 10px; padding: 10px; justify-content: space-between; }
        .kop-logo { height: 50px; width: 50px; }
        .kop-text { font-size: 0.8rem; }
        .txt-opd, .txt-alamat, .kop-text .small { display: none !important; }
        .txt-instansi { font-size: 0.7rem; }
        .txt-sekolah { font-size: 0.9rem; margin: 2px 0; }

        /* GAYA MENU BAWAH (BOTTOM NAVIGATION) */
        .mobile-bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; display: flex; justify-content: space-around; align-items: flex-end; padding: 8px 5px 12px 5px; z-index: 1050; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .mobile-bottom-nav .nav-item-mobile { text-decoration: none; color: #a0aec0; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; font-size: 0.65rem; font-weight: 600; cursor: pointer; flex: 1; transition: 0.3s; padding-bottom: 2px; }
        .mobile-bottom-nav .nav-item-mobile i { font-size: 1.25rem; margin-bottom: 4px; transition: 0.3s; }
        .mobile-bottom-nav .nav-item-mobile.active { color: var(--main-color); }
        .mobile-bottom-nav .nav-item-mobile.active i { transform: translateY(-3px); }

        /* TOMBOL BUAT SURAT KHUSUS (DI TENGAH) */
        .mobile-bottom-nav .btn-buat-surat { position: relative; color: #198754 !important; }
        .mobile-bottom-nav .btn-buat-surat .icon-wrapper { background: linear-gradient(135deg, #198754, #20c997); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 6px; border: 5px solid #f0f2f5; box-shadow: 0 -3px 10px rgba(25, 135, 84, 0.3); position: absolute; top: -45px; transition: 0.3s; }
        .mobile-bottom-nav .btn-buat-surat.active .icon-wrapper { transform: scale(1.1); }
        .mobile-bottom-nav .btn-buat-surat span { margin-top: 25px; }

        /* POSISI TOMBOL SCROLL TOP DINAIIKAN KE ATAS MENU BAWAH */
        .btn-scroll-top { bottom: 100px !important; right: 15px !important; }
    }

  </style>
</head>
<body>
  <button id="btnScrollTop" class="btn btn-primary btn-scroll-top" onclick="window.scrollTo({top:0,behavior:'smooth'})"><i class="fas fa-arrow-up"></i></button>

  <div id="view-login">
    <div class="login-container">
      <div class="login-logos mb-3"><img id="logLogo1" class="login-logo" src=""><img id="logLogo2" class="login-logo" src=""></div>
      <div class="login-instansi" id="logInstansi">INSTANSI</div>
      <div class="login-sekolah" id="logSekolah">LOADING SYSTEM...</div>
      <hr>
      <center><div>
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiy-QcPa6KHScTMhHyA80pZuyStlekpqfdHVhyphenhyphenF-D9CwYNIqLBYra6v1lIO8ndNYU-xCUQl1oBrreAxnH577Diizy_abGpPVs5ocGnfeChx9z5-VzFYMQ-rO9zz61YFXWDEL_n8Vel_JgrL_AHngRpetF0deDJNQ8H0l4j4qUjDwVWpn2kf6_q2UBKGN8tg/s709/logo%20sidimas%20png.png" alt="Logo" class="login-logo2">
        <p class="text-muted small mb-4" style="font-weight: 600">Sistem Digital Manajemen Arsip Surat</p> 
      </div></center>
      <form onsubmit="prosesLogin(event)" autocomplete="off">
        <div class="form-floating mb-3 text-start"><input id="u" class="form-control" placeholder="U" required><label>Username</label></div>
        <div class="input-group mb-4"><div class="form-floating flex-grow-1 text-start"><input id="p" type="password" class="form-control" placeholder="P" required><label>Password</label></div><button class="btn btn-outline-secondary" type="button" onclick="togglePass()"><i class="fas fa-eye" id="iconPass"></i></button></div>
        <button id="btnLogin" class="btn btn-primary w-100 py-2 fw-bold text-uppercase rounded-pill"><span>Masuk Aplikasi</span><span class="spinner-border spinner-border-sm hide" role="status"></span></button>
      </form>
    </div>
    <div class="footer">&copy; 2026 SiDiMAS | All Right Reserved.<br><a href="javascript:void(0)" onclick="modalPrivasi()">Kebijakan Privasi</a> | Created by : <a href='https://www.fary-edtech.my.id' target="_blank" style="color:white">Fary EdTech</a></div>
  </div>

  <div id="view-dashboard" class="hide">
    <div class="d-md-none bg-primary text-white p-3 d-flex align-items-center justify-content-between shadow-sm sticky-top" style="z-index: 1040;">
       <div class="fw-bold fs-5">SiDiMAS</div>
       <div class="admin-only d-flex gap-3">
           <a onclick="nav('users', this)" class="text-white" title="Manajemen User"><i class="fas fa-users-cog fa-lg"></i></a>
           <a onclick="nav('setting', this)" class="text-white" title="Pengaturan"><i class="fas fa-tools fa-lg"></i></a>
       </div>
    </div>

    <nav class="sidebar">
      <div class="text-center mb-4"><h4 class="fw-bold">SiDiMAS</h4><div class="badge bg-warning text-dark rounded-pill px-3" id="lblRole">Role</div></div>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" onclick="nav('home', this)"><i class="fas fa-chart-pie"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link text-white bg-success bg-opacity-25" onclick="nav('buat', this)"><i class="fas fa-file-word"></i>Buat Surat</a></li>
        <li class="nav-item"><a class="nav-link" onclick="nav('masuk', this)"><i class="fas fa-inbox"></i>Surat Masuk</a></li>
        <li class="nav-item"><a class="nav-link" onclick="nav('keluar', this)"><i class="fas fa-paper-plane"></i>Surat Keluar</a></li>
        <li class="nav-item admin-only"><a class="nav-link" onclick="nav('users', this)"><i class="fas fa-users"></i>Manajemen User</a></li>
        <li class="nav-item admin-only"><a class="nav-link" onclick="nav('setting', this)"><i class="fas fa-cogs"></i>Settings</a></li>
        <li class="nav-item mt-5"><a class="nav-link text-white" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i>Logout</a></li>
      </ul>
    </nav>

    <div class="main-content">
      <div class="header-kop shadow-sm">
        <img id="logoKiri" class="kop-logo" src="">
        <div class="kop-text"><span id="txtInstansi" class="txt-instansi"></span><span id="txtOpd" class="txt-opd"></span><span id="txtSekolah" class="txt-sekolah"></span><span id="txtAlamat" class="txt-alamat"></span><div class="small mt-1 text-muted"><span id="txtEmail"></span> | <span id="txtWeb"></span></div></div>
        <img id="logoKanan" class="kop-logo" src="">
      </div>

      <div id="page-home" class="page-view">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="alert alert-light border shadow-sm w-100 mb-0">Selamat Datang, <b id="lblNama" class="text-primary fs-5">User</b>.</div>
            <button class="btn btn-primary btn-refresh ms-2 shadow-sm" onclick="nav('home')" title="Refresh Data"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="row mb-3">
            <div class="col-md-8 mb-3"><div class="card p-3 shadow-sm h-100"><h6 class="text-secondary fw-bold">Statistik Bulanan</h6><div id="chartBulanan" style="height: 300px;"></div></div></div>
            <div class="col-md-4 mb-3"><div class="card p-3 shadow-sm h-100"><h6 class="text-secondary fw-bold">Jenis Surat Keluar</h6><div id="chartJenis" style="height: 300px;"></div></div></div>
        </div>
        <div class="row"><div class="col-md-6 mb-3"><div class="card p-4 text-white bg-primary shadow h-100 border-0"><div class="d-flex justify-content-between align-items-center"><div><h6 class="text-uppercase opacity-75">Surat Masuk</h6><h1 class="fw-bold display-4" id="statMasuk">0</h1></div><i class="fas fa-inbox fa-4x opacity-25"></i></div></div></div><div class="col-md-6 mb-3"><div class="card p-4 text-white bg-success shadow h-100 border-0"><div class="d-flex justify-content-between align-items-center"><div><h6 class="text-uppercase opacity-75">Surat Keluar</h6><h1 class="fw-bold display-4" id="statKeluar">0</h1></div><i class="fas fa-paper-plane fa-4x opacity-25"></i></div></div></div></div>
      </div>

      <div id="page-buat" class="page-view hide">
         <div class="card shadow-sm border-0">
             <div class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="fas fa-magic me-2"></i>Generator Surat</h5><button class="btn btn-light btn-sm btn-refresh text-success" onclick="loadInitData(); gantiFormSurat()" title="Refresh"><i class="fas fa-sync-alt"></i></button></div>
             <div class="card-body">
                 <form id="formGen" onsubmit="submitGenerate(event)" autocomplete="off">
                     <div class="alert alert-success border-success"><label class="fw-bold mb-1">Pilih Jenis Template Surat:<a> (Template disesuaikan dengan Permendagri No. 1 Tahun 2023)</a></label><select id="pilihJenisSurat" name="templateId" class="form-select fw-bold form-select-lg" onchange="gantiFormSurat()"></select></div>
                     <h6 class="text-secondary border-bottom pb-2 mt-4">1. Kepala Surat</h6>
                     <div class="row mb-3">
                        <div class="col-md-5"><label>Kode Klasifikasi (Berdasarkan Permendagri No. 83 Tahun 2022)</label>
                        <select class="form-select" id="selKodeArsip" onchange="updatePreview()"></select></div>
                        <div class="col-md-3"><label>No. Urut Otomatis (bisa diedit)</label><input class="form-control" id="inpNoUrut" placeholder="001" onkeyup="updatePreview()"></div>
                        <div class="col-md-4"><label>Kode Lembaga</label><input class="form-control" id="inpKodeSekolah" placeholder="loading..." onkeyup="updatePreview()" readonly style="background-color: #e9ecef;"></div>
                     </div>
                     <div class="preview-box" id="previewNomor">autoload...</div><input type="hidden" name="nomorFull" id="nomorFull">
                     <div class="row mb-3"><div class="col-md-6"><label>Tempat Titimangsa</label><input name="tempatTitimangsa" class="form-control" placeholder="Contoh: Bungo" required></div><div class="col-md-6"><label>Tanggal Surat</label><input type="date" class="form-control" id="inpTglSurat" onchange="updateTanggalSurat()" required><input type="hidden" name="tanggalSuratFull" id="tanggalSuratFull"></div></div>
                 
                     <h6 class="text-secondary border-bottom pb-2 mt-4">2. Isi Surat</h6>
                     <div id="box-umum" class="form-box">
                        <div class="row mb-2">
                            <div class="col-md-6"><label>Perihal</label><input name="perihal" class="form-control" placeholder="Usulan....."></div>
                            <div class="col-md-2"><label>Sifat Surat</label><select name="sifatSurat" class="form-select"><option>Biasa</option><option>Penting</option><option>Rahasia</option></select></div>
                            <div class="col-md-2"><label>Lampiran</label><input name="lampiranSurat" class="form-control" placeholder="-"></div>
                        </div>
                        <div class="row mb-2"><div class="col-md-10"><label>Kepada (Yth.)</label><input name="tujuanNama" class="form-control" placeholder="Kepala Dinas..."></div></div>
                        <div class="row mb-2">
                        <div class="col-md-6"><label>Up/Cq (kosongkan jika tidak menggunakan)</label><input name="tujuanBidang" class="form-control" placeholder="Up. Kabid..."></div>
                        <div class="col-md-4"><label>Tempat Tujuan</label><input name="tujuanTempat" class="form-control" placeholder="Jambi"></div></div>
                        <div class="mb-2"><label>Isi Paragraf Utama</label><textarea name="isiUmum" class="form-control" rows="4"></textarea></div>
                        <div class="mb-2"><label>Penutup</label><textarea name="isiPenutup" class="form-control" rows="2">Demikianlah Usulan/Permohonan/Pengajuan ini disampaikan...</textarea></div>
                     </div>

                     <div id="box-undangan" class="form-box hide">
                        <div class="row mb-2">
                            <div class="col-md-6"><label>Perihal</label><input name="perihal" class="form-control" placeholder="Undangan...../Pemanggilan orang tua.."></div>
                            <div class="col-md-2"><label>Sifat</label><select name="sifatSurat" class="form-select"><option>Biasa</option><option>Penting</option></select></div>
                            <div class="col-md-2"><label>Lampiran</label><input name="lampiranSurat" class="form-control" placeholder="-"></div>
                        </div>
                        <div class="row mb-2"><div class="col-md-10"><label>Kepada (Yth.)</label><input name="tujuanJabatan" class="form-control" placeholder="Kepala Desa..."></div></div>
                        <div class="row mb-2">
                        <div class="col-md-6"><label>Nama Tujuan</label><input name="tujuanNama" class="form-control" placeholder="Bpk. Ahmad..."></div>
                        <div class="col-md-4"><label>Tempat</label><input name="tujuanTempat" class="form-control"></div></div>
                        <div class="mb-2"><label>Isi Surat</label><textarea name="isiUmum" class="form-control" rows="4"></textarea></div>
                        <div class="bg-light p-3 mb-2 rounded border">
                            <label class="fw-bold text-muted small mb-2">DETAIL KEGIATAN/ACARA:</label>
                            <div class="row g-2">
                                <div class="col-md-6"><label>Nama Kegiatan</label><input name="acaraDetail" class="form-control"></div>
                                <div class="col-md-6"><label>Tempat</label><input name="tempatAcara" class="form-control"></div>
                                <div class="col-md-4"><label>Waktu</label><input name="waktuAcara" class="form-control"></div>
                                <div class="col-md-4"><label>Tgl. Kegiatan</label><input type="date" id="inpTglAcara" class="form-control" onchange="updateHariAcara()"><input type="hidden" name="tglAcaraIndo" id="valTglAcaraIndo"><input type="hidden" name="hariAcara" id="valHariAcara"></div>
                            </div>
                        </div>
                     </div>
                     <div id="box-sk" class="form-box hide">
                        <div class="mb-2"><label>TENTANG</label><input name="perihal" class="form-control" placeholder="PEMBAGIAN TUGAS GURU.............."></div>
                        <div class="mb-2"><label>Menimbang</label><textarea name="skMenimbang" class="form-control" rows="3">a. Bahwa...  b. Bahwa...... dst</textarea></div>
                        <div class="mb-2"><label>Mengingat</label><textarea name="skMengingat" class="form-control" rows="3">1. UU nomor... 2. Permendagri nomor...dst</textarea></div>
                        <div class="mb-2"><label>Menetapkan</label><textarea name="skMenetapkan" class="form-control" rows="5">Kesatu:..... Kedua:............ Ketiga:...........</textarea></div>
                     </div>
                     <div id="box-sppd" class="form-box hide">
                        <div class="mb-2"><label>Maksud Perjalanan Dinas</label><input name="perihal" class="form-control" placeholder="Mengikuti kegiatan bimtek administrasi..."></div>
                        <div class="card p-3 bg-light mb-2"><b class="text-primary">Pegawai:</b><div class="row g-2 mt-1">
                          <div class="col-6"><input name="tujuanNama" class="form-control" placeholder="Nama"></div>
                          <div class="col-6"><input name="tujuanNip" class="form-control" placeholder="NIP"></div>
                          <div class="col-6"><input name="tujuanPangkat" class="form-control" placeholder="Pangkat"></div>
                          <div class="col-6"><input name="tujuanJabatan" class="form-control" placeholder="Jabatan"></div></div></div>
                        <div class="card p-3 bg-light mb-2"><b class="text-success">Perjalanan:</b><div class="row g-2 mt-1">
                          <div class="col-6"><label>Alat Angkutan</label><input name="sppdAngkutan" class="form-control"></div>
                          <div class="col-6"><label>Tempat/Kota Tujuan</label><input name="sppdTujuan" class="form-control"></div>
                          <div class="col-4"><label>Tgl Berangkat</label><input type="date" name="sppdTglMulai" class="form-control"></div>
                          <div class="col-4"><label>Tgl Kembali</label><input type="date" name="sppdTglSelesai" class="form-control"></div>
                          <div class="col-4"><label>Lama (Hari)</label><input name="sppdLama" class="form-control" type="number"></div></div></div>
                     </div>
                     <div id="box-spt" class="form-box hide">
                        <div class="mb-2"><label>Dasar Hukum</label><textarea name="dasarHukum" class="form-control" rows="2"></textarea></div>
                        <div class="card p-3 bg-light mb-2"><b class="text-primary">Kepada:</b><div class="row g-2 mt-1"><div class="col-6"><input name="tujuanNama" class="form-control" placeholder="Nama"></div><div class="col-6"><input name="tujuanNip" class="form-control" placeholder="NIP"></div><div class="col-6"><input name="tujuanPangkat" class="form-control" placeholder="Pangkat"></div><div class="col-6"><input name="tujuanJabatan" class="form-control" placeholder="Jabatan"></div></div></div>
                        <div class="mb-2"><label>Untuk</label><textarea name="isiUmum" class="form-control" rows="3"></textarea></div>
                        <div class="bg-warning bg-opacity-10 p-3 border rounded"><label class="fw-bold small">Waktu:</label><div class="row g-2"><div class="col-6"><label>Mulai</label><input type="date" name="sptMulai" class="form-control"></div><div class="col-6"><label>Selesai</label><input type="date" name="sptSelesai" class="form-control"></div><div class="col-6"><label>Waktu</label><input name="sptWaktu" class="form-control"></div><div class="col-6"><label>Tempat</label><input name="sptTempat" class="form-control"></div></div></div>
                     </div>
                     <div id="box-suket" class="form-box hide">
                        <div class="card p-3 bg-light mb-2"><b class="text-primary">Menerangkan:</b><div class="row g-2 mt-1">
                          <div class="col-6"><input name="tujuanNama" class="form-control" placeholder="Nama"></div>
                          <div class="col-6"><input name="tujuanNip" class="form-control" placeholder="NIP"></div><div class="col-6"><input name="tujuanPangkat" class="form-control" placeholder="Pangkat"></div><div class="col-6"><input name="tujuanJabatan" class="form-control" placeholder="Jabatan"></div></div></div>
                        <div class="mb-2"><label>Isi Keterangan</label><textarea name="suketIsi" class="form-control" rows="4">Adalah benar bahwa.......</textarea></div>
                     </div>
                     <div id="box-nota" class="form-box hide">
                        <div class="mb-2"><label>Kepada Yth.</label><input name="tujuanNama" class="form-control"></div>
                        <div class="row mb-2"><div class="col-md-9"><label>Hal</label><input name="perihal" class="form-control"></div><div class="col-md-3"><label>Sifat</label><select name="sifatSurat" class="form-select"><option>Biasa</option><option>Penting</option><option>Rahasia</option></select></div></div>
                        <div class="mb-2"><label>Isi Nota</label><textarea name="isiUmum" class="form-control" rows="4"></textarea></div>
                     </div>
                     <div id="box-sis" class="form-box hide">
                        <div class="alert alert-info py-2 small">Data Kepala Sekolah diambil otomatis.</div>
                        <div class="card p-3 bg-light mb-2"><b class="text-primary">Data Siswa:</b><div class="row g-2 mt-1"><div class="col-6"><label>Nama Siswa</label><input name="siswaNama" class="form-control"></div><div class="col-6"><label>NIS / NISN</label><input name="siswaNis" class="form-control"></div><div class="col-6"><label>TTL</label><input name="siswaTtl" class="form-control"></div><div class="col-6"><label>JK</label><select name="siswaJk" class="form-select"><option>Laki-laki</option><option>Perempuan</option></select></div><div class="col-6"><label>Kelas</label><input name="siswaKelas" class="form-control"></div><div class="col-6"><label>Ortu</label><input name="siswaOrtu" class="form-control"></div></div></div>
                        <div class="mb-2"><label>Uraian Keterangan</label><textarea name="siswaKet" class="form-control" rows="3">Adalah benar peserta didik...</textarea></div>
                     </div>
                     <div id="box-pengantar" class="form-box hide">
                        <div class="row mb-2"><div class="col-md-10"><label>Kepada (Yth.)</label><input name="tujuanNama" class="form-control" placeholder="Kepala Dinas..."></div></div>
                        <div class="row mb-2"><div class="col-md-6"><label>Up/Cq (kosongkan jika tidak menggunakan)</label><input name="tujuanBidang" class="form-control" placeholder="Up. Kabid..."></div>
                        <div class="col-md-4"><label>Tempat</label><input name="tujuanTempat" class="form-control"></div></div>
                        <div class="card p-3 bg-light border-0"><b class="text-success mb-2 d-block">Isi Tabel Pengantar:</b><div class="mb-2"><label>Isi Surat/Barang yg dikirimkan</label><textarea name="pengantarIsi" class="form-control" rows="3"></textarea></div><div class="row"><div class="col-6"><label>Banyaknya</label><input name="pengantarJml" class="form-control"></div><div class="col-9"><label>Keterangan</label><textarea name="pengantarKet" class="form-control">Disampaikan dengan hormat untuk ditindak lanjuti...</textarea></div></div></div>
                     </div>
                     <div id="box-izin" class="form-box hide">
                        <div class="mb-2"><label>TENTANG</label><input name="perihal" class="form-control" placeholder="IZIN.........."></div>
                        <div class="mb-2"><label>Dasar</label><textarea name="dasarHukum" class="form-control" rows="2"></textarea></div>
                        <div class="card p-3 bg-light mb-2"><b class="text-primary">Memberikan Izin Kepada:</b><div class="row g-2 mt-1"><div class="col-6"><input name="tujuanNama" class="form-control" placeholder="Nama"></div><div class="col-6"><input name="tujuanNip" class="form-control" placeholder="NIP"></div><div class="col-6"><input name="tujuanJabatan" class="form-control" placeholder="Jabatan"></div><div class="col-6"><input name="tujuanAlamat" class="form-control" placeholder="Alamat"></div></div></div>
                        <div class="mb-2"><label>Untuk</label><textarea name="izinAlasan" class="form-control" rows="2"></textarea></div>
                        <div class="row"><div class="col-4"><label>Lama</label><input name="sppdLama" class="form-control" type="number"></div><div class="col-4"><label>Mulai</label><input type="date" name="sppdTglMulai" class="form-control"></div><div class="col-4"><label>s.d</label><input type="date" name="sppdTglSelesai" class="form-control"></div></div>
                     </div>
                     <div id="box-spmt" class="form-box hide">
                        <div class="alert alert-info small py-1">Data Kepala Sekolah diambil otomatis.</div>
                        <div class="card p-3 bg-light mb-2"><b class="text-primary">Data Pegawai:</b><div class="row g-2 mt-1"><div class="col-6"><input name="tujuanNama" class="form-control" placeholder="Nama"></div><div class="col-6"><input name="tujuanNip" class="form-control" placeholder="NIP"></div><div class="col-6"><input name="tujuanPangkat" class="form-control" placeholder="Pangkat/Golongan"></div><div class="col-6"><input name="tujuanJabatan" class="form-control" placeholder="Jabatan"></div></div></div>
                        <div class="mb-2"><label>Berdasarkan Peraturan</label><textarea name="dasarHukum" class="form-control" rows="2" placeholder="SK Nomor..."></textarea></div>
                        <div class="mb-2"><label>Melaksanakan Tugas Sebagai</label><textarea name="spmtJabatanBaru" class="form-control" rows="2"></textarea></div>
                        <div class="row mb-2"><div class="col-6"><label>TMT (Tanggal Mulai)</label><input type="date" name="spmtTglMulai" class="form-control"></div><div class="col-6"><label>Sampai Tanggal</label><input type="date" name="spmtTglSelesai" class="form-control"></div></div>
                     </div>

                     <h6 class="text-secondary border-bottom pb-2 mt-4">3. Penandatangan</h6>
                     <div class="row mb-4">
                        <div class="col-md-3"><label>Nama Kepala</label><input name="ttdNama" class="form-control" required></div>
                        <div class="col-md-3"><label>Pangkat/Gol</label><select name="ttdPangkat" class="form-select"><option>Penata Muda (III/a)</option><option>Penata Muda Tingkat I (III/b)</option><option>Penata (III/c)</option><option>Penata Tingkat I (III/d)</option><option>Pembina (IV/a)</option><option>Pembina Tingkat I (IV/b)</option><option>Pembina Utama Muda (IV/c)</option><option>Pembina Utama Madya (IV/d)</option><option>Pembina Utama (IV/e)</option></select></div>
                        <div class="col-md-3"><label>NIP</label><input name="ttdNip" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required></div>
                        <div class="col-md-3"><label>Tanggal TTD</label><input type="date" class="form-control" id="inpTglSaja" onchange="updateTanggalSaja()" required><input type="hidden" name="tanggalSaja" id="valTglSaja"></div>
                     </div>
                     <button type="submit" id="btnGen" class="btn btn-success w-100 py-3 fw-bold shadow-sm"><span>GENERATE DOKUMEN</span><span class="spinner-border spinner-border-sm hide" role="status"></span></button>
                 </form>
                 <div id="hasilGenerate" class="mt-4 hide text-center p-4 bg-light border border-success rounded">
                    <h4 class="text-success fw-bold mb-3">Dokumen Berhasil Dibuat!</h4>
                    <div class="d-flex justify-content-center gap-3"><a id="linkPdf" target="_blank" class="btn btn-danger btn-lg">Unduh PDF</a><a id="linkWord" target="_blank" class="btn btn-primary btn-lg">Review/Edit Word</a></div>
                    <button class="btn btn-outline-secondary mt-3 btn-sm" onclick="resetGenerator()">Buat Lagi</button>
                 </div>
             </div>
         </div>
      </div>

      <div id="page-masuk" class="page-view hide">
          <div class="card p-3 shadow-sm border-0">
              <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2"><h5 class="text-primary mb-0">Arsip Surat Masuk</h5><div><button class="btn btn-primary btn-sm me-1" onclick="modalInput('masuk', 'add')"><i class="fas fa-plus"></i> Input Baru</button><button class="btn btn-light btn-sm btn-refresh text-primary" onclick="refreshTable('masuk')" title="Refresh"><i class="fas fa-sync-alt"></i></button></div></div>
              <div class="row g-2 mb-3 align-items-end"><div class="col-md-3"><label class="small">Dari</label><input type="date" id="filterM_Start" class="form-control form-control-sm"></div><div class="col-md-3"><label class="small">Sampai</label><input type="date" id="filterM_End" class="form-control form-control-sm"></div><div class="col-md-6"><button class="btn btn-danger btn-sm" onclick="downloadPDF('masuk')"><i class="fas fa-file-pdf"></i> Laporan PDF</button><button class="btn btn-success btn-sm" onclick="downloadExcel('masuk')"><i class="fas fa-file-excel"></i> Export Excel</button></div></div><div class="table-responsive"><table id="tMasuk" class="table table-striped table-bordered w-100 table-full table-hover"></table></div></div>
      </div>
      
      <div id="page-keluar" class="page-view hide">
          <div class="card p-3 shadow-sm border-0">
              <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2"><h5 class="text-success mb-0">Arsip Surat Keluar</h5><div><button class="btn btn-success btn-sm me-1" onclick="modalInput('keluar', 'add')"><i class="fas fa-plus"></i> Input Baru</button><button class="btn btn-light btn-sm btn-refresh text-success" onclick="refreshTable('keluar')" title="Refresh"><i class="fas fa-sync-alt"></i></button></div></div>
              <div class="row g-2 mb-3 align-items-end"><div class="col-md-3"><label class="small">Dari</label><input type="date" id="filterK_Start" class="form-control form-control-sm"></div><div class="col-md-3"><label class="small">Sampai</label><input type="date" id="filterK_End" class="form-control form-control-sm"></div><div class="col-md-6"><button class="btn btn-danger btn-sm" onclick="downloadPDF('keluar')"><i class="fas fa-file-pdf"></i> Laporan PDF</button><button class="btn btn-success btn-sm" onclick="downloadExcel('keluar')"><i class="fas fa-file-excel"></i> Export Excel</button></div></div><div class="table-responsive"><table id="tKeluar" class="table table-striped table-bordered w-100 table-full table-hover"></table></div></div>
      </div>
      
      <div id="page-users" class="page-view hide"><div class="card shadow-sm border-0"><div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Manajemen User</h5><button class="btn btn-light btn-sm btn-refresh text-primary" onclick="loadUsers()" title="Refresh"><i class="fas fa-sync-alt"></i></button></div><div class="card-body"><div class="mb-3"><button class="btn btn-success btn-sm" onclick="modalUser('add')"><i class="fas fa-plus"></i> Tambah User</button></div><div class="table-responsive"><table class="table table-bordered table-hover"><thead class="table-light"><tr><th>Username</th><th>Password</th><th>Role</th><th>Nama Lengkap</th><th>Aksi</th></tr></thead><tbody id="tbody-users"></tbody></table></div></div></div></div>
      
      <div id="page-setting" class="page-view hide">
          <div class="card shadow-sm border-0">
              <div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Pengaturan Aplikasi</h5><button class="btn btn-light btn-sm btn-refresh" onclick="loadInitData()" title="Refresh"><i class="fas fa-sync-alt"></i></button></div>
              <div class="card-body">
                  <div class="alert alert-warning border-warning shadow-sm mb-4"><div class="d-flex justify-content-between align-items-center"><div><i class="fas fa-database fa-lg me-2"></i><strong>Backup Database</strong><div class="small text-muted">Cadangkan data surat masuk, keluar, dan user ke Spreadsheet baru.</div></div><button id="btnBackup" class="btn btn-warning fw-bold" onclick="doBackup()"><span>Backup Sekarang</span><span class="spinner-border spinner-border-sm hide" role="status"></span></button></div></div>
                   <form onsubmit="simpanSetting(event)" autocomplete="off">
                      <h6 class="text-primary border-bottom pb-2">Identitas Sekolah</h6>
                      <div class="row mb-2">
                      <div class="col-md-6"><label class="text-success">Logo Instansi</label><input type="file" id="fLogo1" class="form-control" accept="image/*"></div>
                      <div class="col-md-6"><label class="text-success">Logo Sekolah</label><input type="file" id="fLogo2" class="form-control" accept="image/*"></div></div>
                      <div class="row mb-2">
                      <div class="col-md-6"><label class="text-success">Nama Instansi</label><input name="namaInstansi" id="inInstansi" class="form-control" placeholder="PEMERINTAH PROVINSI..."></div>
                      <div class="col-md-6"><label class="text-success">Nama Dinas/OPD (boleh dikosongkan)</label><input name="namaOpd" id="inOpd" class="form-control" placeholder="ex. DINAS PENDIDIKAN......"></div></div>
                      <label class="text-success">Nama Sekolah</label><input name="namaSekolah" id="inSekolah" class="form-control mb-2 fw-bold">
                      <label class="text-success">Alamat Lengkap</label><input name="alamatSekolah" id="inAlamat" class="form-control mb-2">

                      <div class="row mb-2">
                      <div class="col-md-6"><label class="text-success">Email</label><input name="emailSekolah" id="inEmail" class="form-control"></div>
                      <div class="col-md-6"><label class="text-success">Website</label><input name="webSekolah" id="inWeb" class="form-control"></div></div>

                      <div class="mb-3"><label class="fw-bold text-success">Kode Lembaga</label><input class="form-control border-success" list="listLembaga" name="kodeLembaga" id="inKodeLembaga" placeholder="Ketik manual atau pilih dari daftar..."><datalist id="listLembaga"></datalist></div>
                      
                      <h6 class="text-primary border-bottom pb-2 mt-4">Data Kepala Sekolah</h6>
                      <div class="row mb-2">
                      <div class="col-md-6"><label class="text-success">Nama Lengkap</label><input name="kepsekNama" id="inKepsekNama" class="form-control"></div>
                      <div class="col-md-6"><label class="text-success">NIP</label><input name="kepsekNip" id="inKepsekNip" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div></div>
                      <div class="row mb-2">
                      <div class="col-md-6"><label class="text-success">Pangkat/Golongan</label><select name="kepsekPangkat" id="inKepsekPangkat" class="form-select"><option>Pengatur Muda (II/a)</option><option>Pengatur Muda Tingkat I (II/b)</option><option>Pengatur (II/c)</option><option>Pengatur Tingkat I (II/d)</option><option>Penata Muda (III/a)</option><option>Penata Muda Tingkat I (III/b)</option><option>Penata (III/c)</option><option>Penata Tingkat I (III/d)</option><option>Pembina (IV/a)</option><option>Pembina Tingkat I (IV/b)</option><option>Pembina Utama Muda (IV/c)</option><option>Pembina Utama Madya (IV/d)</option><option>Pembina Utama (IV/e)</option></select></div>
                      <div class="col-md-6"><label class="text-success">Kota/Tempat TTD Surat</label><input name="kotaSurat" id="inKotaSurat" class="form-control"></div></div>
                      <h6 class="text-primary border-bottom pb-2 mt-4">Tampilan</h6>
                      <label class="text-success">Warna Tema</label><input type="color" name="warnaAplikasi" id="inWarna" class="form-control form-control-color w-100 mb-3">
                      <button class="btn btn-primary w-100"><i class="fas fa-save"></i> SIMPAN PENGATURAN</button>
                  </form>
              </div>
          </div>
      </div>
      <div class="footer">&copy; 2026 SiDiMAS | All Right Reserved. <br> <a href="javascript:void(0)" onclick="modalPrivasi()">Kebijakan Privasi</a> | Created by : <a href='https://www.fary-edtech.my.id' target="_blank" style="color:blue">Fary EdTech</a></div>
    </div>

    <div class="mobile-bottom-nav d-md-none">
          <a class="nav-item-mobile active" onclick="nav('home', this)">
              <i class="fas fa-chart-pie"></i>
              <span>Dashboard</span>
          </a>
          <a class="nav-item-mobile" onclick="nav('masuk', this)">
              <i class="fas fa-inbox"></i>
              <span>Srt Masuk</span>
          </a>
          <a class="nav-item-mobile btn-buat-surat" onclick="nav('buat', this)">
              <div class="icon-wrapper"><i class="fas fa-magic"></i></div>
              <span>Buat Surat</span>
          </a>
          <a class="nav-item-mobile" onclick="nav('keluar', this)">
              <i class="fas fa-paper-plane"></i>
              <span>Srt Keluar</span>
          </a>
          <a class="nav-item-mobile text-danger" onclick="doLogout()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
          </a>
      </div>
  </div>

  <div class="modal fade" id="modalSurat" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header bg-primary text-white"><h5 class="modal-title" id="judulModal">Input Data</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                  <form id="fSurat" onsubmit="submitSurat(event)" autocomplete="off">
                      <input type="hidden" name="jenisForm" id="mJenis"><input type="hidden" name="mode" id="mMode"><input type="hidden" name="idSurat" id="mId"><input type="hidden" name="fileLama" id="mFileLama">
                      <div id="divMasuk" class="hide">
                          <div class="row mb-2"><div class="col"><label>Tgl Diterima</label><input type="date" name="tglTerima" id="inTglTerima" class="form-control req-in"></div><div class="col"><label>Pengirim</label><input name="pengirim" id="inPengirim" class="form-control"></div></div>
                          <div class="row mb-2"><div class="col"><label>Tgl Surat</label><input type="date" name="tglSurat" id="inTglSuratM" class="form-control"></div><div class="col"><label>No Surat</label><input name="noSurat" id="inNoSuratM" class="form-control"></div></div>
                          <div class="mb-2"><label>Perihal</label><input name="perihal" id="inPerihalM" class="form-control req-in"></div>
                          <div class="mb-2"><label>Ditujukan Kepada</label><input name="ditujukan" id="inTujuanM" class="form-control"></div>
                          <div class="mb-2"><label>Uraian</label><textarea name="uraian" id="inUraianM" class="form-control" rows="2"></textarea></div>
                          <div class="mb-2"><label>Keterangan</label><input name="keterangan" id="inKetM" class="form-control"></div>
                          <div class="mb-2"><label class="fw-bold">Upload Scan (PDF/IMG/DOC/ZIP Max 500KB)</label><input type="file" id="fileMasuk" class="form-control"></div>
                      </div>
                      <div id="divKeluar" class="hide">
                          <div class="row mb-2"><div class="col"><label>Tgl Surat</label><input type="date" name="tglSurat" id="inTglSuratK" class="form-control req-out"></div><div class="col"><label>Klasifikasi</label><select name="jenisSurat" id="inJenisK" class="form-select"><option>Surat Dinas/Umum</option><option>Surat Tugas</option><option>Surat Perjalanan Dinas</option><option>Surat Keputusan (SK)</option><option>Surat Pengantar</option><option>Surat Undangan</option><option>Surat Izin</option><option>SPMT</option><option>Nota Dinas</option></select></div></div>
                          <div class="row mb-2"><div class="col"><label>No Surat</label><input name="noSurat" id="inNoSuratK" class="form-control req-out"></div><div class="col"><label>Perihal</label><input name="perihal" id="inPerihalK" class="form-control req-out"></div></div>
                          <div class="mb-2"><label>Tujuan Surat</label><input name="tujuan" id="inTujuanK" class="form-control"></div>
                          <div class="mb-2"><label>Uraian</label><textarea name="uraian" id="inUraianK" class="form-control" rows="2"></textarea></div>
                          <div class="mb-2"><label>Keterangan</label><input name="keterangan" id="inKetK" class="form-control"></div>
                          <div class="mb-2"><label class="fw-bold">Upload File (PDF/IMG/DOC/ZIP Max 500KB)</label><input type="file" id="fileKeluar" class="form-control"></div>
                      </div>
                      <button id="btnSimpan" class="btn btn-primary w-100 mt-3 fw-bold"><span>SIMPAN DATA</span><span class="spinner-border spinner-border-sm hide" role="status"></span></button>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Tutup Kembali</button>
              </div>
          </div>
      </div>
  </div>

  <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="submitUser(event)"><input type="hidden" name="mode" id="uMode"><input type="hidden" name="oldUsername" id="uOld"><div class="mb-2"><label>Username</label><input name="username" id="uName" class="form-control" required></div><div class="mb-2"><label>Password</label><input name="password" id="uPass" class="form-control" required></div><div class="mb-2"><label>Role</label><select name="role" id="uRole" class="form-select"><option value="Admin">Admin</option><option value="User">User</option></select></div><div class="mb-3"><label>Nama Lengkap</label><input name="nama" id="uFull" class="form-control" required></div><button class="btn btn-success w-100">Simpan</button></form></div></div></div></div>
  
  <div class="modal fade" id="modalPrivasi" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header"><h5 class="modal-title">Kebijakan Privasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                  <p><strong>SiDiMAS (Sistem Digital Manajemen Arsip Surat)</strong></p>
                  <span style="font-size:10px">
                     <p>1. Pendahuluan.   <br>Kami menghargai privasi Anda. Kebijakan ini menjelaskan bagaimana SiDiMAS mengelola data Anda saat menggunakan fitur pembuatan surat otomatis dan manajemen arsip digital.</p>
  <p>2. Informasi yang Kami Kumpulkan
    <br> Untuk menjalankan fungsinya, SiDiMAS memproses data berikut: <br> - Data Surat: Informasi detail mengenai surat masuk dan keluar (seperti Nomor Surat, Perihal, Tanggal, Pengirim, dan Tujuan) yang Anda input ke dalam sistem. <br> - Dokumen Digital: File fisik surat (hasil scan atau PDF) yang Anda unggah untuk diarsipkan. <br> - Identitas Pengguna: Alamat email dan nama akun Google Anda untuk keperluan akses login dan pencatatan aktivitas (audit log).</p>
  <p>3. Penggunaan Data <br> Data tersebut digunakan secara eksklusif untuk tujuan operasional aplikasi: <br> - Otomatisasi: Mengenerate file surat secara otomatis berdasarkan data yang Anda input <br> - Database: Mencatat, merekap, dan melacak riwayat surat masuk dan keluar. <br> - Pengarsipan: Menyimpan dan mengorganisir dokumen digital agar mudah dicari kembali di Google Drive.</p>
  <p>4. Izin Akses (Permissions) <br> Aplikasi ini memerlukan izin akses ke akun Google Workspace Anda untuk: <br> - Google Sheets: Membaca dan menulis data pada buku agenda surat masuk/keluar. <br> - Google Docs: Membuat draf dan mencetak surat baru. <br> - Google Drive: Menyimpan file arsip dan mengakses template surat. </p>
  <p>5. Penyimpanan Data <br> SiDiMAS beroperasi di lingkungan Google Apps Script. Kami tidak menyalin data Anda ke server pihak ketiga. Seluruh data surat, database, dan file arsip tersimpan aman di dalam Google Drive dan Google Sheets milik Instansi/Organisasi Anda sendiri. </p>
  <p>6. Keamanan & Pembagian Data <br> Kami tidak membagikan atau menjual data surat Anda kepada pihak mana pun. Akses terhadap data hanya dimiliki oleh pengguna yang telah diberi wewenang oleh Admin Instansi. </p>
                      <p><strong>Kontak Developer : </strong> <br>Jika ada pertanyaan mengenai penggunaan data di SiDiMAS, silakan hubungi: Fary EdTech, Hp/WA : <a href='https://wa.me/6285219901909' target="_blank" style="color:blue">085219901909<a> </p> 
                  </span>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">Saya Mengerti</button>
              </div>
          </div>
      </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script>
  /* --- KONFIGURASI API (URL DARI GOOGLE APPS SCRIPT) --- */
  // NANTI GANTI LINK DI BAWAH INI DENGAN LINK HASIL DEPLOY APPS SCRIPT KAMU
  const API_URL = "https://script.google.com/macros/s/AKfycbynWLV2F7YeZS4rA60JS4mYVTIVp5GP6ciabnSz3JEGYOFoCCTO4w4EtO-vHj9ENdpC/exec"; 

  /* --- FUNGSI JEMBATAN PENGHUBUNG (FETCH API) --- */
  async function apiCall(actionName, payloadData = {}) {
      try {
          const response = await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain' }, // Pakai text/plain untuk bypass CORS preflight
              body: JSON.stringify({ action: actionName, payload: payloadData }),
              redirect: 'follow'
          });
          return await response.json();
      } catch (error) {
          console.error("Koneksi API Gagal:", error);
          throw error;
      }
  }

  /* --- GLOBAL VARIABLES --- */
  let dbMasuk = []; 
  let dbKeluar = []; 

  /* --- INIT DATA & DASHBOARD --- */
  $(document).ready(function() {
    renderSettingsFromCache(); 
    checkSession(); 
    
    const dateNow = new Date();
    const offset = dateNow.getTimezoneOffset() * 60000;
    const today = (new Date(dateNow - offset)).toISOString().slice(0, 10);
    
    $('#filterM_Start, #filterM_End, #filterK_Start, #filterK_End, #inpTglSurat, #inpTglSaja').val(today);
    $('#selKodeArsip').select2({ theme: "bootstrap-5", width: '100%', dropdownParent: $('#formGen').parent() });
    $('#inpNoUrut').on('change blur', function() { formatNomorUrut(this); updatePreview(); });
    $(window).scroll(function() { if ($(this).scrollTop() > 100) $('#btnScrollTop').fadeIn(); else $('#btnScrollTop').fadeOut(); });

    updateTanggalSaja();

    $('#fileMasuk, #fileKeluar').on('change', function() {
        const file = this.files[0];
        if (file) {
            if (!file.type.match(/image.*/)) {
                if (file.size > 500 * 1024) { 
                    this.value = ''; 
                    Swal.fire({ icon: 'warning', title: 'File Terlalu Besar', text: 'Maksimal ukuran file dokumen adalah 500KB.', target: '#modalSurat' });
                }
            }
        }
    });

    loadInitData(); 
  });

  function renderAppAttributes(s) {
      if(!s) return;
      localStorage.setItem('sidimas_settings', JSON.stringify(s));
      if(s.app_color) document.documentElement.style.setProperty('--main-color', s.app_color);
      
      if(s.logo_instansi && s.logo_instansi.length>50) { $('#logLogo1, #logoKiri').attr('src', s.logo_instansi).show(); } else { $('#logLogo1, #logoKiri').hide(); }
      if(s.logo_sekolah && s.logo_sekolah.length>50) { $('#logLogo2, #logoKanan').attr('src', s.logo_sekolah).show(); } else { $('#logLogo2, #logoKanan').hide(); }
      
      $('#logInstansi').text((s.nama_instansi||'')+' '+(s.nama_opd||'')); 
      $('#logSekolah').text(s.nama_sekolah||'LOADING...');
      $('#txtInstansi').text(s.nama_instansi); $('#txtOpd').text(s.nama_opd); $('#txtSekolah').text(s.nama_sekolah); 
      $('#txtAlamat').text(s.alamat_sekolah); $('#txtEmail').text(s.email_sekolah); $('#txtWeb').text(s.website_sekolah);
      
      $('#inInstansi').val(s.nama_instansi); $('#inOpd').val(s.nama_opd); $('#inSekolah').val(s.nama_sekolah); 
      $('#inAlamat').val(s.alamat_sekolah); $('#inEmail').val(s.email_sekolah); $('#inWeb').val(s.website_sekolah); $('#inWarna').val(s.app_color);
      $('#inKepsekNama').val(s.kepsek_nama); $('#inKepsekNip').val(s.kepsek_nip); 
      $('#inKepsekPangkat').val(s.kepsek_pangkat); $('#inKotaSurat').val(s.kota_surat); $('#inKodeLembaga').val(s.kode_lembaga);
      
      if(!$('input[name="ttdNama"]').val()) $('input[name="ttdNama"]').val(s.kepsek_nama);
      if(!$('input[name="ttdNip"]').val()) $('input[name="ttdNip"]').val(s.kepsek_nip);
      if(!$('input[name="ttdPangkat"]').val()) $('input[name="ttdPangkat"]').val(s.kepsek_pangkat);
      $('#inpKodeSekolah').val(s.kode_lembaga);
  }

  function renderSettingsFromCache() {
      const cached = localStorage.getItem('sidimas_settings');
      if (cached) { try { renderAppAttributes(JSON.parse(cached)); } catch (e) {} }
  }

  function loadInitData() {
    apiCall('getSettings').then(s => renderAppAttributes(s));
    
    if($('#selKodeArsip').children('option').length <= 1) {
        const cacheKode = localStorage.getItem('sidimas_kode_arsip');
        if(cacheKode) $('#selKodeArsip').html(cacheKode);
        apiCall('getKodeArsip').then(l => { 
            let o='<option value="">-- Pilih Kode (Ketik untuk mencari...) --</option>'; l.forEach(k=>o+=`<option value="${k.c}">${k.l}</option>`); 
            $('#selKodeArsip').html(o); localStorage.setItem('sidimas_kode_arsip', o); 
        });
    }
    if($('#pilihJenisSurat').children('option').length <= 1) {
        apiCall('getTemplateList').then(l => { 
            let o='<option value="">-- Pilih Template --</option>'; l.forEach(t=>o+=`<option value="${t.id}">${t.name}</option>`); $('#pilihJenisSurat').html(o); 
        });
    }
    apiCall('getRefLembaga').then(l => { let opts = ''; l.forEach(x => opts += `<option value="${x.k}">${x.n}</option>`); $('#listLembaga').html(opts); });
  }

  function setBtnLoading(btnId, isLoading, defaultText) {
      const btn = $(btnId);
      if (isLoading) {
          btn.prop('disabled', true);
          if(btn.find('.spinner-border').length > 0){ btn.find('.spinner-border').removeClass('hide'); if(defaultText) btn.find('span:not(.spinner-border)').text(defaultText); } else { btn.html('<span class="spinner-border spinner-border-sm"></span> Loading...'); }
      } else {
          btn.prop('disabled', false);
          if(btn.find('.spinner-border').length > 0){ btn.find('.spinner-border').addClass('hide'); btn.find('span:not(.spinner-border)').text(defaultText); } else { btn.text(defaultText); }
      }
  }

  /* --- FUNGSI LOADING DENGAN TIMER MUNDUR --- */
  function showLoadingTimer(judul) {
      let timerInterval;
      Swal.fire({
          title: judul,
          html: 'Waktu tunggu: <b>5</b> detik...',
          allowOutsideClick: false,
          didOpen: () => {
              Swal.showLoading();
              const b = Swal.getHtmlContainer().querySelector('b');
              let timeLeft = 5;
              timerInterval = setInterval(() => {
                  timeLeft--;
                  if (timeLeft > 0) {
                      if (b) b.textContent = timeLeft;
                  } else {
                      Swal.getHtmlContainer().innerHTML = 'Sedang proses, mohon tunggu sebentar...';
                      clearInterval(timerInterval);
                  }
              }, 1000);
          },
          willClose: () => {
              clearInterval(timerInterval);
          }
      });
  }

  function showLoadingTimer2(judul) {
      let timerInterval;
      Swal.fire({
          title: judul,
          html: 'Waktu tunggu: <b>10</b> detik...',
          allowOutsideClick: false,
          didOpen: () => {
              Swal.showLoading();
              const b = Swal.getHtmlContainer().querySelector('b');
              let timeLeft = 10;
              timerInterval = setInterval(() => {
                  timeLeft--;
                  if (timeLeft > 0) {
                      if (b) b.textContent = timeLeft;
                  } else {
                      Swal.getHtmlContainer().innerHTML = 'Sedang proses, mohon tunggu sebentar...';
                      clearInterval(timerInterval);
                  }
              }, 1000);
          },
          willClose: () => {
              clearInterval(timerInterval);
          }
      });
  }

  function formatNomorUrut(input) { let val = input.value; if(val === "") return; input.value = String(val).padStart(3, '0'); }

  /* --- AUTHENTICATION & SESSION --- */
  function checkSession() {
    const user = localStorage.getItem('sidimas_user');
    const role = localStorage.getItem('sidimas_role');
    const nama = localStorage.getItem('sidimas_nama');
    if (user && role) {
      $('.modal-backdrop').remove(); $('body').removeClass('modal-open');
      $('#view-login').addClass('hide').css('display', 'none'); 
      $('#view-dashboard').removeClass('hide');
      $('#lblRole').text(role); $('#lblNama').text(nama);
      if (role !== 'Admin') $('.admin-only').hide(); else $('.admin-only').show();
      if($('#view-dashboard').is(':visible') && $('.nav-link.active').length === 0) { nav('home'); }
    } else { 
        $('#view-dashboard').addClass('hide'); 
        $('#view-login').removeClass('hide').css('display', 'flex'); 
    }
  }

  function prosesLogin(e) {
    e.preventDefault(); 
    setBtnLoading('#btnLogin', true, 'Memverifikasi...');
    apiCall('checkLogin', { u: $('#u').val(), p: $('#p').val() })
      .then(r => {
        setBtnLoading('#btnLogin', false, 'Masuk Aplikasi');
        if (r.status) { 
          localStorage.setItem('sidimas_user', $('#u').val()); localStorage.setItem('sidimas_role', r.role); localStorage.setItem('sidimas_nama', r.nama); 
          $('#view-login').fadeOut(300, function() { $(this).addClass('hide').css('display','none'); $('#view-dashboard').removeClass('hide').hide().fadeIn(300); checkSession(); });
        } else { Swal.fire('Login Gagal', r.message, 'error'); }
      })
      .catch(() => { setBtnLoading('#btnLogin', false, 'Masuk Aplikasi'); Swal.fire('Error', 'Gagal memanggil API', 'error'); });
  }
  
  function doLogout() { 
    Swal.fire({ title: 'Logout?', text: 'Keluar dari aplikasi?', icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Keluar' }).then(r => { 
      if(r.isConfirmed){ 
          localStorage.clear(); 
          $('#view-dashboard').addClass('hide'); 
          $('#view-login').removeClass('hide').css('display', 'flex').hide().fadeIn(300);
          $('#u').val(''); $('#p').val(''); dbMasuk = []; dbKeluar = [];
      }
    }); 
  }
  function togglePass() { const x=document.getElementById("p"); x.type=(x.type==="password")?"text":"password"; }

  /* --- FILE HANDLING --- */
  function resizeImage(file) { 
      return new Promise(res => { if(!file) res(null); const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'); const s=100/i.height; c.height=100; c.width=i.width*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); res(c.toDataURL('image/png',0.8)); }; i.src=e.target.result; }; r.readAsDataURL(file); }); 
  }
  
  function compressImageForUpload(file) {
      return new Promise(res => {
          if (!file) res(null);
          const r = new FileReader();
          r.onload = e => {
              const i = new Image();
              i.onload = () => {
                  const canvas = document.createElement('canvas');
                  let width = i.width; let height = i.height; const maxDim = 1000;
                  if (width > height) { if (width > maxDim) { height *= maxDim / width; width = maxDim; } } else { if (height > maxDim) { width *= maxDim / height; height = maxDim; } }
                  canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(i, 0, 0, width, height);
                  res(canvas.toDataURL('image/jpeg', 0.7)); 
              }; i.src = e.target.result;
          }; r.readAsDataURL(file);
      });
  }

  function processFile(id) { 
      return new Promise(resolve => { 
          const input = document.getElementById(id); const file = input.files[0]; if (!file) { resolve(null); return; }
          if (!file.type.match(/image.*/)) {
              if (file.size > 500 * 1024) { 
                  Swal.fire({ icon:'warning', title:'File Terlalu Besar', text:'Maksimal 500KB', target:'#modalSurat' }); 
                  resolve(null); return; 
              }
              const r = new FileReader(); r.onload = e => resolve({name: file.name, mimeType: file.type, data: e.target.result.split(',')[1]}); r.readAsDataURL(file);
          } else {
              compressImageForUpload(file).then(base64 => { resolve({name: file.name.replace(/\.[^/.]+$/, "") + ".jpg", mimeType: "image/jpeg", data: base64.split(',')[1]}); });
          }
      }); 
  }

  function simpanSetting(e) { 
      e.preventDefault(); showLoadingTimer('Menyimpan Pengaturan...'); 
      Promise.all([resizeImage(document.getElementById('fLogo1').files[0]), resizeImage(document.getElementById('fLogo2').files[0])]).then(imgs=>{ 
          const fd=new FormData(e.target); const d=Object.fromEntries(fd); 
          if(imgs[0]) d.b64_instansi=imgs[0]; if(imgs[1]) d.b64_sekolah=imgs[1]; 
          
          apiCall('saveSettings', d).then(r => {
             Swal.close(); 
             if(r && r.success === false) { Swal.fire('Error', r.message, 'error'); } 
             else { Swal.fire('Sukses', 'Pengaturan diterapkan', 'success'); loadInitData(); } 
          }); 
      }); 
  }
  function doBackup() {
     Swal.fire({ title: 'Backup Database?', text: "Data akan disalin ke Spreadsheet baru di folder Arsip.", icon: 'info', showCancelButton: true, confirmButtonText: 'Ya, Backup', cancelButtonText: 'Batal' }).then((result) => {
        if (result.isConfirmed) {
           setBtnLoading('#btnBackup', true, 'Memproses...');
           apiCall('backupDatabase').then(r => {
              setBtnLoading('#btnBackup', false, 'Backup Sekarang');
              if (r.success) { Swal.fire({ title: 'Backup Berhasil!', html: `File tersimpan di folder Arsip.<br><a href="${r.url}" target="_blank" class="btn btn-sm btn-primary mt-2">Buka File Backup</a>`, icon: 'success' }); } else { Swal.fire('Gagal Backup', r.message, 'error'); }
           }).catch(e => { setBtnLoading('#btnBackup', false, 'Backup Sekarang'); Swal.fire('Error Server', e.toString(), 'error'); });
        }
     });
  }

  /* --- GENERATOR SURAT --- */
  function gantiFormSurat() { 
    const t = $('#pilihJenisSurat option:selected').text().toLowerCase() || ""; 
    $('.form-box').addClass('hide').find('input,textarea,select').prop('disabled', true); 
    let aid = '#box-umum'; 
    if (t.includes('melaksanakan tugas') || t.includes('spmt')) { aid = '#box-spmt'; } else if (t.includes('keterangan siswa') || t.includes('siswa')) { aid = '#box-sis'; } else if (t.includes('tugas') || t.includes('spt')) { aid = '#box-spt'; } else if (t.includes('sk')) { aid = '#box-sk'; } else if (t.includes('perjalanan')) { aid = '#box-sppd'; } else if (t.includes('surat izin') || t.includes('izin')) { aid = '#box-izin'; } else if (t.includes('keterangan')) { aid = '#box-suket'; } else if (t.includes('nota')) { aid = '#box-nota'; } else if (t.includes('pengantar')) { aid = '#box-pengantar'; } else if (t.includes('undangan')) { aid = '#box-undangan'; }
    $(aid).removeClass('hide').find('input,textarea,select').prop('disabled', false); 
    loadAutoNumber();
  }
  function loadAutoNumber() { apiCall('getAutoNumberData').then(r => { if (r.success) { if($('#inpNoUrut').val() === "") { $('#inpNoUrut').val(r.nextNo); } $('#inpKodeSekolah').val(r.kodeSekolah); updatePreview(); } }); }
  function updatePreview() { const d=new Date(); const romawi = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"][d.getMonth()]; const f=`${$('#selKodeArsip').val()||'...'}/${$('#inpNoUrut').val()||'...'}/${$('#inpKodeSekolah').val()||'...'}/${romawi}/${d.getFullYear()}`; $('#previewNomor').text(f); $('#nomorFull').val(f); }
  function updateTanggalSurat() { if($('#inpTglSurat').val()) { const tgl = new Date($('#inpTglSurat').val()).toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'}); const kota = $('#inKotaSurat').val() || "Tempat"; $('#tanggalSuratFull').val(kota + ", " + tgl); } }
  function updateTanggalSaja() { const v=$('#inpTglSaja').val(); if(v){ const d=new Date(v); $('#valHariSaja').val(d.toLocaleDateString('id-ID',{weekday:'long'})); $('#valTglSaja').val(d.toLocaleDateString('id-ID',{year:'numeric',month:'long',day:'numeric'})); } }
  function updateHariAcara() { const v=$('#inpTglAcara').val(); if(v){ const d=new Date(v); $('#valHariAcara').val(d.toLocaleDateString('id-ID',{weekday:'long'})); $('#valTglAcaraIndo').val(d.toLocaleDateString('id-ID',{year:'numeric',month:'long',day:'numeric'})); } }
  
  
  function submitGenerate(e) { 
    e.preventDefault(); 
    if(!$('#inpTglSurat').val()){Swal.fire('Info','Tgl Surat wajib diisi','warning');return;} 
    
    setBtnLoading('#btnGen', true, 'Memproses...'); 
    updatePreview(); updateTanggalSurat(); updateTanggalSaja(); updateHariAcara(); 
    const fd = new FormData(e.target); const dataObj = Object.fromEntries(fd); 
    
    // --- INI BARIS TAMBAHANNYA ---
    showLoadingTimer2('Membuat Dokumen...');

    apiCall('generateDokumen', dataObj)
       .then(r=>{ 
          setBtnLoading('#btnGen', false, 'GENERATE DOKUMEN'); 
          if(r.success){ 
              $('#hasilGenerate').removeClass('hide'); 
              $('#linkPdf').attr('href',r.pdfUrl); 
              $('#linkWord').attr('href',r.wordUrl); 
              $('html,body').animate({scrollTop:$("#hasilGenerate").offset().top},500); 
              // Swal berhasil akan menutup pop-up timer otomatis
              Swal.fire('Berhasil', 'Dokumen siap diunduh', 'success'); 
          } else { 
              Swal.fire('Gagal',r.message,'error'); 
          } 
       })
       .catch(err => { 
           setBtnLoading('#btnGen', false, 'GENERATE DOKUMEN'); 
           Swal.fire('Error', err.toString(), 'error'); 
       }); 
}

  function resetGenerator() { $('#formGen')[0].reset(); $('#hasilGenerate').addClass('hide'); $('#selKodeArsip').val('').trigger('change'); const dateNow = new Date(); const offset = dateNow.getTimezoneOffset() * 60000; const today = (new Date(dateNow - offset)).toISOString().slice(0, 10); $('#inpTglSurat').val(today); gantiFormSurat(); updatePreview(); $('html,body').animate({scrollTop:0},500); }

  /* --- NAVIGATION & TABLES --- */
  function nav(p, el) { 
    $('.modal-backdrop').remove(); $('body').removeClass('modal-open'); $('body').css('overflow', 'auto'); Swal.close();
    $('.page-view').addClass('hide'); $('#page-'+p).removeClass('hide'); 
    
    /* Bagian yang diubah: Reset active class untuk desktop dan mobile */
    $('.nav-link, .nav-item-mobile').removeClass('active'); 
    if(el) {
        $(el).addClass('active'); 
    } else { 
        $(`.nav-link[onclick="nav('${p}', this)"]`).addClass('active');
        $(`.nav-item-mobile[onclick="nav('${p}', this)"]`).addClass('active');
    }
    
    // Sisa fungsinya tetap sama...
    if(p==='home') { loadInitData(); loadDashboardStats(); } 
    if(p==='masuk') refreshTable('masuk'); 
    if(p==='keluar') refreshTable('keluar'); 
    if(p==='users') loadUsers(); 
    if(p==='buat') { loadAutoNumber(); }
  }
    
  
  function loadDashboardStats() {
      $('#chartBulanan').empty(); $('#chartJenis').empty();
      apiCall('getDashboardData').then(d => {
          $('#statMasuk').text(d.totalMasuk); 
          $('#statKeluar').text(d.totalKeluar);
          renderCharts(d);
      });
  }
  
  function refreshAllTables() { loadDashboardStats(); }
  
  function renderCharts(data) {
    Highcharts.chart('chartBulanan', {
        chart: { type: 'column' },
        title: { text: null },
        xAxis: { categories: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Ags','Sep','Okt','Nov','Des'] },
        yAxis: { min: 0, title: { text: 'Jumlah Surat' } },
        series: [{ name: 'Surat Masuk', data: data.bulanMasuk, color: '#0d6efd' }, { name: 'Surat Keluar', data: data.bulanKeluar, color: '#198754' }],
        credits: { enabled: false }
    });

    const jenisData = [];
    if(data.jenisKeluar) { for (const [key, value] of Object.entries(data.jenisKeluar)) { jenisData.push({ name: key, y: value }); } }
    Highcharts.chart('chartJenis', {
        chart: { type: 'pie' },
        title: { text: null },
        tooltip: { pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' },
        plotOptions: { pie: { allowPointSelect: true, cursor: 'pointer', dataLabels: { enabled: false }, showInLegend: true } },
        series: [{ name: 'Persentase', colorByPoint: true, data: jenisData }],
        credits: { enabled: false }
    });
  }

  function refreshTable(j) { 
    const tid = (j==='masuk') ? '#tMasuk' : '#tKeluar'; 
    if($.fn.DataTable.isDataTable(tid)) { $(tid).DataTable().destroy(); }
    $(tid).html('<tbody><tr><td colspan="12" class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><div class="mt-2 text-muted">Mengambil data terbaru...</div></td></tr></tbody>');

    apiCall('ambilData', { jenis: j }).then(d => { 
      if(j === 'masuk') { dbMasuk = d || []; } else { dbKeluar = d || []; } 
      const r = (j==='masuk') ? dbMasuk : dbKeluar;
      const cm=[ {title:"ID",visible:false}, {title:"Tgl Terima"},{title:"Pengirim"},{title:"Tgl Surat"},{title:"No Surat"}, {title:"Perihal"},{title:"Tujuan"},{title:"Uraian"},{title:"Ket"}, {title:"File",render:btnFile}, {title:"Aksi",render:(d,t,row,meta) => renderAksi(meta.row, 'masuk')} ]; 
      const ck=[ {title:"ID",visible:false}, {title:"Tgl Surat"},{title:"Klasifikasi"},{title:"No Surat"},{title:"Perihal"}, {title:"Tujuan"},{title:"Uraian"},{title:"Ket"}, {title:"File",render:btnFile}, {title:"Aksi",render:(d,t,row,meta) => renderAksi(meta.row, 'keluar')} ]; 
      
      $(tid).DataTable({ data: r, columns: (j==='masuk')?cm:ck, scrollX: true, destroy: true, language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" }, order: [[0,'desc']] }); 
    }); 
  }
  
  function renderAksi(index, jenis) {
    const row = getDataByIndex(jenis, index);
    const currentUser = localStorage.getItem('sidimas_user'); const currentRole = localStorage.getItem('sidimas_role'); 
    const creator = row[row.length - 1]; 
    let isLocked = false;
    if (currentRole !== 'Admin') { if (!creator || creator !== currentUser) { isLocked = true; } }
    if (isLocked) { return `<span class="badge bg-secondary"><i class="fas fa-lock"></i> Locked</span>`; } 
    else { return `<div class="btn-group" role="group"><button class="btn btn-sm btn-info text-white" onclick="viewSurat('${jenis}', ${index})" title="Lihat"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-warning" onclick="editSurat('${jenis}', ${index})" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="delSurat('${jenis}', ${index})" title="Hapus"><i class="fas fa-trash"></i></button></div>`; }
  }
  
  function btnFile(d){ return (!d||d.length<5)?'-':`<a href="${d}" target="_blank" class="btn btn-sm btn-primary"><i class="fas fa-download"></i></a>`; }
  
  /* ================= EXPORT & CRUD ================= */
  function downloadPDF(j) { 
    const s=(j==='masuk')?$('#filterM_Start').val():$('#filterK_Start').val(); 
    const e=(j==='masuk')?$('#filterM_End').val():$('#filterK_End').val(); 
    if(!s||!e){ Swal.fire('Info','Pilih tanggal','warning'); return; } 
    
    // Gunakan loading timer baru!
    showLoadingTimer('Menyiapkan PDF...'); 
    
    apiCall('getLaporanRawHTML', {jenis: j, tglAwal: s, tglAkhir: e}).then(r=>{ 
        if(r.success) {
            // Kita proses HTML menjadi PDF secara instan di HP/Laptop pengguna
            const element = document.createElement('div');
            element.innerHTML = r.html;
            
            const opt = {
              margin:       0.5,
              filename:     'Laporan_Surat_' + j.toUpperCase() + '.pdf',
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2 },
              jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                Swal.close();
            });
        } else { 
            Swal.fire('Error', r.message || 'Gagal memuat laporan', 'error'); 
        } 
    }).catch(err => {
        Swal.fire('Error', 'Terjadi kesalahan sistem', 'error');
    }); 
}

 function downloadExcel(j) { const s=(j==='masuk')?$('#filterM_Start').val():$('#filterK_Start').val(); const e=(j==='masuk')?$('#filterM_End').val():$('#filterK_End').val(); if(!s||!e){Swal.fire('Info','Pilih tanggal','warning');return;} showLoadingTimer('Memproses Excel...'); apiCall('generateLaporanExcel', {jenis: j, tglAwal: s, tglAkhir: e}).then(r=>{ Swal.close(); if(r.success) window.open(r.url,'_blank'); else Swal.fire('Err',r.message,'error'); }); }
  
  function modalInput(j, mode) { 
    $('#fSurat')[0].reset(); $('#fSurat').removeClass('was-validated'); $('#mJenis').val(j); $('#mMode').val(mode); $('#divMasuk,#divKeluar').addClass('hide'); $('#btnSimpan').show(); setBtnLoading('#btnSimpan', false, 'SIMPAN DATA');
    $('input,textarea,select').prop('disabled', false); $('#divMasuk').find('input,textarea,select').prop('disabled', true); $('#divKeluar').find('input,textarea,select').prop('disabled', true);
    if(mode === 'view') { $('#judulModal').text('Detail Data'); $('#btnSimpan').hide(); $('.modal-body').find('input,textarea,select').prop('disabled', true); } else { $('#judulModal').text(mode==='add'?'Input Baru':'Edit Data'); }
    if(j==='masuk'){ $('#divMasuk').removeClass('hide'); if(mode !== 'view') { $('#divMasuk').find('input,textarea,select').prop('disabled', false); $('.req-in').prop('required', true); } } else { $('#divKeluar').removeClass('hide'); if(mode !== 'view') { $('#divKeluar').find('input,textarea,select').prop('disabled', false); $('.req-out').prop('required', true); } } 
    new bootstrap.Modal('#modalSurat').show(); 
  }
  function getDataByIndex(jenis, index) { return (jenis === 'masuk') ? dbMasuk[index] : dbKeluar[index]; }
  function viewSurat(jenis, index) { const row = getDataByIndex(jenis, index); modalInput(jenis, 'view'); fillForm(jenis, row); }
  function editSurat(jenis, index) { const row = getDataByIndex(jenis, index); modalInput(jenis, 'edit'); $('#mId').val(row[0]); fillForm(jenis, row); }
  function fillForm(jenis, row) { if(jenis === 'masuk') { $('#inTglTerima').val(row[1]); $('#inPengirim').val(row[2]); $('#inTglSuratM').val(row[3]); $('#inNoSuratM').val(row[4]); $('#inPerihalM').val(row[5]); $('#inTujuanM').val(row[6]); $('#inUraianM').val(row[7]); $('#inKetM').val(row[8]); $('#mFileLama').val(row[9]); } else { $('#inTglSuratK').val(row[1]); $('#inJenisK').val(row[2]); $('#inNoSuratK').val(row[3]); $('#inPerihalK').val(row[4]); $('#inTujuanK').val(row[5]); $('#inUraianK').val(row[6]); $('#inKetK').val(row[7]); $('#mFileLama').val(row[8]); } }
  function delSurat(jenis, index) { const row = getDataByIndex(jenis, index); const id = row[0]; const u = localStorage.getItem('sidimas_user'); const r = localStorage.getItem('sidimas_role'); Swal.fire({ title:'Hapus Data?', text:"Data tidak bisa dikembalikan!", icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'Ya, Hapus' }).then((res)=>{ if(res.isConfirmed) { Swal.showLoading(); apiCall('deleteSurat', {id: id, jenis: jenis, user: u, role: r}).then(resp => { if(resp.success) { Swal.fire('Terhapus','','success'); refreshTable(jenis); refreshAllTables(); } else Swal.fire('Gagal', resp.message, 'error'); }); } }); }
  
  
  function submitSurat(e) { 
    e.preventDefault(); 
    if(!document.getElementById('fSurat').checkValidity()){ 
        e.stopPropagation(); document.getElementById('fSurat').classList.add('was-validated'); return; 
    } 
    
    // Loading di tombol tetap berjalan
    setBtnLoading('#btnSimpan', true, 'Menyimpan...'); 
    
    const j=$('#mJenis').val(); 
    processFile(j==='masuk'?'fileMasuk':'fileKeluar').then(f=>{ 
        if (document.getElementById(j==='masuk'?'fileMasuk':'fileKeluar').files.length > 0 && f === null) { 
            setBtnLoading('#btnSimpan', false, 'SIMPAN DATA'); return; 
        }
        const fd = new FormData(e.target); const dataObj = Object.fromEntries(fd); 
        dataObj.currentUser = localStorage.getItem('sidimas_user'); 
        dataObj.currentRole = localStorage.getItem('sidimas_role'); 
        
        // --- INI BARIS TAMBAHANNYA: Memunculkan Pop-up Timer Mundur ---
        showLoadingTimer('Menyimpan Data...');

        apiCall('simpanData', { data: dataObj, fileInfo: f })
           .then(r=>{ 
              setBtnLoading('#btnSimpan', false, 'SIMPAN DATA'); 
              // Notifikasi Swal di bawah ini akan otomatis menggantikan/menutup pop-up timer
              if(r.success){ 
                  Swal.fire('Berhasil','Data tersimpan','success'); 
                  bootstrap.Modal.getInstance('#modalSurat').hide(); 
                  refreshTable(j); refreshAllTables(); 
              } else { 
                  Swal.fire('Akses Ditolak',r.message,'error'); 
              } 
           })
           .catch(err => { 
               setBtnLoading('#btnSimpan', false, 'SIMPAN DATA'); 
               Swal.fire('Error Server', err.toString(), 'error'); 
           }); 
    }); 
}

  /* --- MANAJEMEN USER --- */
  function modalUser(m,u,p,r,n) { $('#uMode').val(m); if(m==='add'){ $('#uName').val('').prop('readonly',false);$('#uPass,#uFull').val(''); } else { $('#uOld').val(u); $('#uName').val(u).prop('readonly',true); $('#uPass').val(p); $('#uRole').val(r); $('#uFull').val(n); } new bootstrap.Modal('#modalUser').show(); }
  function submitUser(e) { e.preventDefault(); showLoadingTimer('Menyimpan User...'); apiCall('saveUser', Object.fromEntries(new FormData(e.target))).then(r=>{ if(r.success){ Swal.fire('OK','Disimpan','success'); bootstrap.Modal.getInstance('#modalUser').hide(); loadUsers(); }else Swal.fire('Err',r.message,'error'); }); }

  /*--KHUSUS DEMO DINONAKTIFKAN EDIT DAN HAPUS--*/
  function loadUsers() { apiCall('getUsersList')
  .then(r=>{ let h=''; r.forEach(u=>{ h+=`<tr><td>${u[0]}</td><td>******</td><td>${u[2]}</td><td>${u[3]}</td><td>
  <button class="btn btn-sm btn-warning" onclick="modalUser('edit','${u[0]}','${u[1]}','${u[2]}','${u[3]}')" title="Edit"><i class="fas fa-edit"></i></button>
  <button class="btn btn-sm btn-danger" onclick="delUser('${u[0]}')" title="Hapus"><i class="fas fa-trash"></i></button>
  </td></tr>`; }); $('#tbody-users').html(h); }); }

  
  function delUser(u) { if(confirm('Hapus User ini?')) apiCall('deleteUser', {u: u}).then(loadUsers); }
  function modalPrivasi(){ new bootstrap.Modal(document.getElementById('modalPrivasi')).show(); }
</script>


</body>
</html>
